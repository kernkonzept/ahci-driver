-- vim:set ft=lua:
--
-- Sample LUA start configuration for AHCI client examples.
--
-- In order to execute this example on qemu a disk file needs to be
-- created first and then added to QMU using the following options:
--
--  -device ahci,id=ahci0 -drive if=none,file=<filename>,format=raw,id=drive-sata0-0-0 -device ide-hd,bus=ahci0.0,drive=drive-sata0-0-0,id=sata0-0-0

local t = require("rom/test_env");

local L4 = require("L4");

local l = L4.default_loader;

-- channel between io and ahci driver
local io_bus = l:new_channel();
-- factory channel to ahci driver for connecting new clients
-- (unused in this example)
local ahci_bus = l:new_channel();
-- channel between ahci driver and client
local ahcicl1 = l:new_channel();

local ahci_io = " rom/ahci.io"
if L4.Info.arch() == "arm" or L4.Info.arch() == "arm64" then
  -- AHCI device attached to PCIe ECAM bridge
  ahci_io = " rom/pcie-ecam.io"..ahci_io
end

-- Start io, used for access to hardware resources.
-- A sample io configuration for the ahci driver can be found in ahci.io.
l:start(
  {
    caps =
      {
        ahcidrv = io_bus:svr(),
        icu     = L4.Env.icu,
        iommu   = L4.Env.iommu,
        sigma0  = L4.cast(L4.Proto.Factory, L4.Env.sigma0):create(L4.Proto.Sigma0),
      },
    log  = { "IO", "y" },
  },
  "rom/io"..ahci_io);

-- Start the ahci driver server. The client is configured staticly.
l:start(
  {
    caps =
      {
        vbus = io_bus,
        svr = ahci_bus:svr(),
        -- Create a communication channel to the client.
        cl1 = ahcicl1:svr()
      },
    log      = { "ahci", "g" },
  },
  -- The command line parameters configures which disk should be
  -- attached. Each parameter is a triple of capability, disk id
  -- and number of dataspaces. The disk id can either be the HD id
  -- as reported on the AHCI info page or the UUID of a partition.
  --"rom/ahci-drv cl1,QM00005,5");
  "rom/ahci-drv -A --client cl1 --device 88E59675-4DC8-469A-98E4-B7B021DC7FBE --ds-max 5");

-- Start the example client
l:start(
  {
    caps =
      {
        -- Create a communication channel to the server.
        -- The example expects this to be called 'dsk'.
        dsk = ahcicl1
      },
    log      = { "test", "r" },
  },
  "rom/" .. t.TEST_PROG); -- "rom/ahci-md5-sync" or "rom/ahci-md5-async"
